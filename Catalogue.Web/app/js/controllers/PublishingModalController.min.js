(function(){angular.module("app.controllers").controller("PublishingModalController",function(n,t,i,r){var h,u,e,f,s,o;return h=function(n){var t,i,r;return r=n.getFullYear(),i=o(n.getMonth()+1),t=o(n.getDate()),""+t+"/"+i+"/"+r},o=function(n){return n<10?"0"+n:n},n.assessmentRequest={},n.assessmentRequest.id=n.form.id,n.recordOutput=r,u={riskAssessment:{currentClass:{},completed:{}},signOff:{currentClass:{},completed:{},timeout:{},showButton:{}},upload:{currentClass:{},completed:{}},currentActiveView:{}},n.publishingStatus=u,u.signOff.timeout=-1,n.refreshPublishingStatus=function(){return n.form.publication!==null&&n.form.publication.target.gov!==null&&(u.riskAssessment.completed=n.form.publication.assessment!==null&&n.form.publication.assessment.completed,u.signOff.completed=n.form.publication.signOff!==null,u.upload.completed=n.form.publication.target.gov.lastSuccess!==null),u.riskAssessment.currentClass=n.recordOutput.recordState.publishingState.assessedAndUpToDate?"visited":u.riskAssessment.completed?"current":"current",u.signOff.currentClass=n.recordOutput.recordState.publishingState.signedOffAndUpToDate?"visited":n.recordOutput.recordState.publishingState.assessedAndUpToDate?"current":"disabled",u.upload.currentClass=n.recordOutput.recordState.publishingState.publishedToGovAndUpToDate?"visited":n.recordOutput.recordState.publishingState.signedOffAndUpToDate?"current":"disabled"},n.refreshPublishingStatus(),u.currentActiveView=n.recordOutput.recordState.publishingState.signedOffAndUpToDate?"upload":n.recordOutput.recordState.publishingState.assessedAndUpToDate?"sign off":"risk assessment",e=function(){if(n.form.publication!==null&&n.form.publication.assessment!==null&&n.form.publication.assessment.completed)return n.assessmentCompletedInfo=n.form.publication.assessment.completedByUser===null&&n.form.publication.assessment.initialAssessmentWasDoneOnSpreadsheet?"Initial assessment completed on spreadsheet":n.recordOutput.recordState.publishingState.assessedAndUpToDate?"Completed by "+n.form.publication.assessment.completedByUser.displayName+" on "+moment(new Date(n.form.publication.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a"):"Last completed by "+n.form.publication.assessment.completedByUser.displayName+" on "+moment(new Date(n.form.publication.assessment.completedOnUtc)).format("DD MMM YYYY h:mm a")},f=function(){return u.signOff.showButton=n.user.isIaoUser&&!n.recordOutput.recordState.publishingState.signedOffAndUpToDate,n.form.publication!==null&&n.form.publication.signOff!==null&&(n.signOffCompletedInfo=n.form.publication.signOff.user===null?"Initial sign off completed on spreadsheet":n.recordOutput.recordState.publishingState.signedOffAndUpToDate?"Signed off by "+n.form.publication.signOff.user.displayName+" on "+moment(new Date(n.form.publication.signOff.dateUtc)).format("DD MMM YYYY h:mm a"):"Last signed off by "+n.form.publication.signOff.user.displayName+" on "+moment(new Date(n.form.publication.signOff.dateUtc)).format("DD MMM YYYY h:mm a")),u.signOff.signOffButtonText=n.user.isIaoUser?"SIGN OFF":"Pending sign off"},s=function(){return n.hubPublishingStatus=function(){return n.form.publication.target.hub===null?"Pending":n.form.publication.target.hub.lastSuccess!==null&&(n.recordOutput.recordState.publishingState.publishedToHubAndUpToDate||n.recordOutput.recordState.publishingState.publishedToGovAndUpToDate)?"Completed on "+moment(new Date(n.form.publication.target.hub.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a"):n.form.publication.target.hub.lastSuccess!==null?"Pending - last completed on "+moment(new Date(n.form.publication.target.hub.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a"):n.form.publication.target.hub.lastAttempt!==null?"Pending - last attempted on "+moment(new Date(n.form.publication.target.hub.lastAttempt.dateUtc)).format("DD MMM YYYY h:mm a"):"Pending"},n.govPublishingStatus=function(){return n.form.publication.target.gov===null?"Pending":n.form.publication.target.gov.lastSuccess!==null&&n.recordOutput.recordState.publishingState.publishedToGovAndUpToDate?"Completed on "+moment(new Date(n.form.publication.target.gov.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a"):n.form.publication.target.gov.lastSuccess!==null?"Pending - last completed on "+moment(new Date(n.form.publication.target.gov.lastSuccess.dateUtc)).format("DD MMM YYYY h:mm a"):n.form.publication.target.gov.lastAttempt!==null?"Pending - last failed on "+moment(new Date(n.form.publication.target.gov.lastAttempt.dateUtc)).format("DD MMM YYYY h:mm a")+' with error "'+n.form.publication.target.gov.lastAttempt.message+'"':"Pending"},n.uploadStatus=n.recordOutput.recordState.publishingState.publishedToGovAndUpToDate?"Publishing completed":"Publishing in progress..."},e(),f(),s(),n.assessButtonClick=function(){return t.put("../api/publishing/assess",n.assessmentRequest).success(function(t){return n.status.refresh(),n.form=t.record,n.recordOutput={record:t.record,recordState:t.recordState},e(),n.refreshPublishingStatus(),u.currentActiveView="sign off"})["catch"](function(t){return n.notifications.add(t.data.exceptionMessage),n.$dismiss()})},n.signOffButtonClick=function(){return u.signOff.timeout===-1?(u.signOff.timeout=10,n.allowGraceTime()):n.cancelSignOff()},n.submitSignOff=function(){return n.signOffRequest={id:n.form.id,comment:""},t.put("../api/publishing/signoff",n.signOffRequest).success(function(t){return n.form=t.record,n.recordOutput={record:t.record,recordState:t.recordState,publishingPolicy:t.publishingPolicy},n.status.refresh(),f(),n.refreshPublishingStatus(),u.currentActiveView="upload"})["catch"](function(t){return t.status===401?n.notifications.add("Unauthorised - not in valid sign off group"):n.notifications.add(t.data.exceptionMessage),u.signOff.timeout=-1,n.$dismiss()})},n.allowGraceTime=function(){return u.signOff.timeout>0?(u.signOff.signOffButtonText="Cancel "+("0"+u.signOff.timeout--).slice(-2),i(n.allowGraceTime,1e3)):u.signOff.timeout===0?(i.cancel,n.submitSignOff()):void 0},n.cancelSignOff=function(){return i.cancel,u.signOff.timeout=-1,f()},n.close=function(){return n.$close(n.recordOutput)}})}).call(this);