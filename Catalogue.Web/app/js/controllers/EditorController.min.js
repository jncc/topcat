(function(){var t,l,n,i,r,u,f,e,o,a,s,h,c;angular.module("app.controllers").controller("EditorController",function(l,a,v,y,p,w,b){return b.then(function(n){return l.user=n}),l.editing={},l.lookups={},l.lookups.currentDataFormat={},l.recordOutput=p,l.vocabulator={},l.$=$,a.get("../api/topics").success(function(n){return l.lookups.topics=n}),a.get("../api/formats?q=").success(function(t){return l.lookups.currentDataFormat=n(l.form.gemini.dataFormat,t),l.lookups.formats=t}),a.get("../api/roles?q=").success(function(n){return l.lookups.roles=n}),l.collapseDataFormatSelector=!0,l.collapseDateFormat=!0,l.getSecurityText=o,l.getDataFormatObj=n,l.updateDataFormatObj=c,l.getPendingSignOff=r,l.getPublishingText=f,l.getPublishButtonTooltip=u,l.getFormattedDate=i,l.addPublishableResource=t,l.removePublishableResource=s,l.trimDoubleQuotes=h,l.getResourceUrl=e,l.cancel=function(){return l.reset(),l.lookups.currentDataFormat=n(l.form.gemini.dataFormat,l.lookups.formats),l.notifications.add("Edits cancelled")},l.open=function(n,t){n.preventDefault();n.stopPropagation();l[t]=!0},l.successResponse=function(n){return l.reloadRecord(n),l.notifications.add("Edits saved")},l.reloadRecord=function(n){return l.recordOutput={record:n.record,recordState:n.recordState},l.validation={},l.reset(),l.status.refresh(),y.path("/editor/"+l.recordOutput.record.id)},l.save=function(){var n;return n=function(n){var f,t,e,i,r,o,s,u;if(n.data.success)l.successResponse(n.data);else if(l.validation=n.data.validation,t=n.data.validation.errors,t.length>0)for(l.notifications.add("There were errors"),i=0,o=t.length;i<o;i++)for(f=t[i],u=f.fields,r=0,s=u.length;r<s;r++){e=u[r];try{l.theForm[e].$setValidity("server",!1)}catch(h){}}return l.busy.stop()},l.busy.start(),l.isNew()?a.post("../api/records",l.form).then(n):a.put("../api/records/"+l.recordOutput.record.id,l.form).then(n)},l.clone=function(){return y.path("/clone/"+l.form.id)},l.reset=function(){return l.form=angular.copy(l.recordOutput.record)},l.isNew=function(){return l.form.id==="00000000-0000-0000-0000-000000000000"},l.isClean=function(){return angular.equals(l.form,l.recordOutput.record)},l.isSaveHidden=function(){return l.isClean()||l.recordOutput.record.readOnly},l.isCancelHidden=function(){return l.isClean()},l.isSaveDisabled=function(){return l.isClean()},l.isCloneHidden=function(){return l.isNew()},l.isCloneDisabled=function(){return!l.isClean()},l.isPublishDisabled=function(){return!l.isSaveHidden()||l.form.validation!==1},l.isPublishHidden=function(){return!(l.form.publication&&l.form.publication.target&&(l.form.publication.target.hub&&l.form.publication.target.hub.publishable===!0||l.form.publication.target.gov&&l.form.publication.target.gov.publishable===!0))},l.isHttpPath=function(n){return n&&n.toLowerCase().startsWith("http")},l.hasUsageConstraints=function(){return!!l.form.gemini.limitationsOnPublicAccess&&l.form.gemini.limitationsOnPublicAccess!=="no limitations"||!!l.form.gemini.useConstraints&&l.form.gemini.useConstraints!=="no conditions apply"},l.removeKeyword=function(n){return l.form.gemini.keywords.splice($.inArray(n,l.form.gemini.keywords),1)},l.addKeywords=function(n){var r,t,u,i;for(i=[],t=0,u=n.length;t<u;t++)r=n[t],i.push(l.form.gemini.keywords.push(r));return i},l.editKeywords=function(){var n;return n=w.open({controller:"VocabulatorController",templateUrl:"views/partials/vocabulator.html?"+(new Date).getTime(),size:"lg",scope:l}),n.result.then(function(n){return l.addKeywords(n)})["finally"](function(){return l.editing.keywords=!0})},l.editAbstract=function(){var n;return n=w.open({controller:"MarkdownController",templateUrl:"views/partials/markdown.html?"+(new Date).getTime(),size:"lg",resolve:{markdown:function(){return l.form.gemini.abstract}}}),n.result.then(function(n){return l.form.gemini.abstract=n})},l.openPublishingModal=function(){var n;return n=w.open({controller:"PublishingModalController",templateUrl:"views/partials/publishingmodal.html?"+(new Date).getTime(),size:"lg",scope:l,resolve:{recordOutput:function(){return l.recordOutput}},backdrop:"static"}),n.result.then(function(n){return l.reloadRecord(n)})},l.openImagePicker=function(){var n;return n=w.open({controller:"ImagePickerController",templateUrl:"views/partials/imagepicker.html?"+(new Date).getTime(),size:"lg",scope:l,resolve:{recordOutput:function(){return l.recordOutput}}}),n.result.then(function(n){return l.reloadRecord(n)})},l.removeExtent=function(n){return l.form.gemini.extent.splice($.inArray(n,l.form.gemini.extent),1)},l.addExtent=function(){return l.form.gemini.extent===null&&(l.form.gemini.extent=[]),l.form.gemini.extent.push({authority:"",code:""})},l.reset(),l.getKeywords=function(n){return a.get("../api/keywords?q="+n).then(function(n){return n.data})},l.setKeyword=function(n,t){return t.vocab=n.vocab},l.fillManagerDetails=function(){return l.form.manager||(l.form.manager={}),l.form.manager.displayName=l.user.displayName}});a=function(n){return n&&n.match(/^([a-z]:|\\\\jncc-corpfile\\)/i)};t=function(n){return n.publication||(n.publication={}),n.publication.data||(n.publication.data={}),n.publication.data.resources||(n.publication.data.resources=[]),n.publication.data.resources.push({path:""})};e=function(n){return n.path.startsWith("http://")||n.path.startsWith("https://")?n.path:n.publishedUrl!==null?n.publishedUrl:null};s=function(n,t){return n.publication.data.resources.splice($.inArray(t,n.publication.data.resources),1)};h=function(n){return n.match(/^(").*(")$/)?n.substring(1,n.length-1):n};u=function(n){return n.validation===1?"View the publishing workflow":"Validation level must be Gemini"};f=function(n,t){var r,i;return r="Never Published",i=null,n.publication&&n.publication.target&&(n.publication.target.gov&&n.publication.target.gov.lastSuccess||n.publication.target.hub&&n.publication.target.hub.lastSuccess)&&(r="Published"),n.publication&&n.publication.target&&(r!=="Published"||t.assessedAndUpToDate?!t.signedOffAndUpToDate||t.publishedToHubAndUpToDate||t.publishedToGovAndUpToDate?!t.assessedAndUpToDate||t.publishedToHubAndUpToDate||t.publishedToGovAndUpToDate||(i="Assessed"):i="Signed Off":i="Out Of Date"),i!==null?r+", "+i:r};i=function(n){return moment(new Date(n)).format("DD MMM YYYY")};r=function(n){return n!==null&&n.assessment.completed&&n.signOff===null?!0:!1};o=function(n){switch(n){case 0:return"Official";case 1:return"Official-Sensitive";case 2:return"Secret"}};n=function(n,t){var i,r,u,f,o,s,e;if(n!==void 0&&t!==void 0){for(u=0,o=t.length;u<o;u++)for(r=t[u],e=r.formats,f=0,s=e.length;f<s;f++)if(i=e[f],i.name===n)return{type:r.name,text:i.name,code:i.code,glyph:r.glyph};return{text:"None Selected",glyph:"glyphicon-th"}}return{text:"Other",glyph:"glyphicon-th"}};c=function(t,i,r){return r.gemini.dataFormat=t,n(t,i)};l={errors:[{message:"There was an error"},{message:"There was another error"}]}}).call(this);