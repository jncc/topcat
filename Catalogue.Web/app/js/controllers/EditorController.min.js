(function(){var h,n,u,f,e,o,t,i,r,s;angular.module("app.controllers").controller("EditorController",function(h,c,l,a,v,y){return h.editing={},h.lookups={},h.lookups.currentDataFormat={},h.record=v,h.vocabulator={},h.$=$,c.get("../api/topics").success(function(n){return h.lookups.topics=n}),c.get("../api/formats?q=").success(function(t){return h.lookups.currentDataFormat=n(h.form.gemini.dataFormat,t),h.lookups.formats=t}),c.get("../api/roles?q=").success(function(n){return h.lookups.roles=n}),h.collapseDataFormatSelector=!0,h.collapseDateFormat=!0,h.getSecurityText=o,h.getDataFormatObj=n,h.updateDataFormatObj=s,h.getPendingSignOff=e,h.getOpenDataButtonText=u,h.isAssessedAndUpToDate=t,h.isSignedOffAndUpToDate=i,h.isUploadedAndUpToDate=r,h.getOpenDataButtonToolTip=f,h.cancel=function(){return h.reset(),h.lookups.currentDataFormat=n(h.form.gemini.dataFormat,h.lookups.formats),h.notifications.add("Edits cancelled")},h.open=function(n,t){n.preventDefault();n.stopPropagation();h[t]=!0},h.successResponse=function(n){return h.reloadRecord(n),h.notifications.add("Edits saved")},h.reloadRecord=function(n){return h.record=n,h.validation={},h.reset(),h.status.refresh(),a.path("/editor/"+h.record.id)},h.save=function(){var n;return n=function(n){var f,t,e,i,r,o,s,u;if(n.data.success)h.successResponse(n.data.record);else if(h.validation=n.data.validation,t=n.data.validation.errors,t.length>0)for(h.notifications.add("There were errors"),i=0,o=t.length;i<o;i++)for(f=t[i],u=f.fields,r=0,s=u.length;r<s;r++){e=u[r];try{h.theForm[e].$setValidity("server",!1)}catch(c){}}return h.busy.stop()},h.busy.start(),h.isNew()?c.post("../api/records",h.form).then(n):c.put("../api/records/"+h.record.id,h.form).then(n)},h.clone=function(){return a.path("/clone/"+h.form.id)},h.reset=function(){return h.form=angular.copy(h.record)},h.isNew=function(){return h.form.id==="00000000-0000-0000-0000-000000000000"},h.isClean=function(){return angular.equals(h.form,h.record)},h.isSaveHidden=function(){return h.isClean()||h.record.readOnly},h.isCancelHidden=function(){return h.isClean()},h.isSaveDisabled=function(){return h.isClean()},h.isCloneHidden=function(){return h.isNew()},h.isCloneDisabled=function(){return!h.isClean()},h.isPublishingModalButtonDisabled=function(){return!h.isSaveHidden()},h.hasUsageConstraints=function(){return!!h.form.gemini.limitationsOnPublicAccess&&h.form.gemini.limitationsOnPublicAccess!=="no limitations"||!!h.form.gemini.useConstraints&&h.form.gemini.useConstraints!=="no conditions apply"},h.removeKeyword=function(n){return h.form.gemini.keywords.splice($.inArray(n,h.form.gemini.keywords),1)},h.addKeywords=function(n){var r,t,u,i;for(i=[],t=0,u=n.length;t<u;t++)r=n[t],i.push(h.form.gemini.keywords.push(r));return i},h.editKeywords=function(){var n;return n=y.open({controller:"VocabulatorController",templateUrl:"views/partials/vocabulator.html?"+(new Date).getTime(),size:"lg",scope:h}),n.result.then(function(n){return h.addKeywords(n)})["finally"](function(){return h.editing.keywords=!0})},h.editAbstract=function(){var n;return n=y.open({controller:"MarkdownController",templateUrl:"views/partials/markdown.html?"+(new Date).getTime(),size:"lg",resolve:{markdown:function(){return h.form.gemini.abstract}}}),n.result.then(function(n){return h.form.gemini.abstract=n})},h.openPublishingModal=function(){var n;return n=y.open({controller:"OpenDataModalController",templateUrl:"views/partials/opendatamodal.html?"+(new Date).getTime(),size:"lg",scope:h,backdrop:"static"}),n.result.then(function(n){return h.reloadRecord(n)})},h.removeExtent=function(n){return h.form.gemini.extent.splice($.inArray(n,h.form.gemini.extent),1)},h.addExtent=function(){return h.form.gemini.extent===null&&(h.form.gemini.extent=[]),h.form.gemini.extent.push({authority:"",code:""})},h.reset(),h.getKeywords=function(n){return c.get("../api/keywords?q="+n).then(function(n){return n.data})},h.setKeyword=function(n,t){return t.vocab=n.vocab}});f=function(n){return n.publication===null?"The open data publication status of the record, editing the record may affect the status.":n.publication.openData.lastSuccess===null||t(n)?"The open data publication status of the record, editing the record may affect the status.":"This record has been changed since it was last published, it may need republishing."};u=function(n){return n.publication===null?"Not Open Data":n.publication.openData.lastSuccess===null||t(n)?r(n)?"Published":i(n)?"Signed Off":t(n)?"Assessed":"Not Open Data":"Republish"};e=function(n){return n!==null&&n.openData.assessment.completed&&n.openData.signOff===null?!0:!1};o=function(n){switch(n){case 0:return"Official";case 1:return"Official-Sensitive";case 2:return"Secret"}};n=function(n,t){var i,r,u,f,o,s,e;if(n!==void 0&&t!==void 0){for(u=0,o=t.length;u<o;u++)for(r=t[u],e=r.formats,f=0,s=e.length;f<s;f++)if(i=e[f],i.name===n)return{type:r.name,text:i.name,code:i.code,glyph:r.glyph};return{text:"None Selected",glyph:"glyphicon-th"}}return{text:"Other",glyph:"glyphicon-th"}};s=function(t,i,r){return r.gemini.dataFormat=t,n(t,i)};h={errors:[{message:"There was an error"},{message:"There was another error"}]};t=function(n){return n.publication===null?!1:n.publication.openData.assessment.completed?n.publication.openData.assessment.completedOnUtc===n.gemini.metadataDate?!0:i(n):!1};i=function(n){return n.publication===null?!1:n.publication.openData.signOff!==null&&n.publication.openData.signOff.dateUtc===n.gemini.metadataDate?!0:n.publication.openData.lastAttempt!==null&&n.publication.openData.lastAttempt.dateUtc===n.gemini.metadataDate?!0:r(n)};r=function(n){return n.publication===null?!1:n.publication.openData.lastSuccess!==null&&n.publication.openData.lastSuccess.dateUtc===n.gemini.metadataDate?!0:!1}}).call(this);