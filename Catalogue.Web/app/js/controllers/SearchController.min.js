(function(){var n=[].indexOf||function(n){for(var t=0,i=this.length;t<i;t++)if(t in this&&this[t]===n)return t;return-1};angular.module("app.controllers").controller("SearchController",function(t,i,r,u,f,e,o){var s,h,c,l,a;return t.app={starting:!0},f(function(){return t.app.starting=!1},500),t.result={results:{}},t.current={},t.pageSize=15,t.vocabulator={},t.resultsView="list",a=function(n){var t;return t=s(),r.search("q",n.q||null),r.search("k",n.k),r.search("p",n.p||null),r.search("d",n.d||null)},l=function(n){return u.get("../api/search?"+$.param(n,!0)).success(function(i){if(angular.equals(i.query,n))return t.result=i}).error(function(n){return t.notifications.add("Oops! "+n.message)})},c=function(n){return n.q?u.get("../api/keywords?q="+n.q).success(function(n){return t.keywordSuggestions=n}).error(function(n){return t.notifications.add("Oops! "+n.message)}):e.defer()},t.doSearch=function(n){var i,r;return a(n),n.q||n.k[0]?(t.busy.start(),i=c(n),r=l(n),e.all([i,r])["finally"](function(){return t.busy.stop(),t.result.query.q?void 0:t.keywordSuggestions={}})):(t.keywordSuggestions={},t.result={})},s=function(){return{q:"",k:[],p:0,n:t.pageSize,d:null}},h=function(){var n;return n=r.search(),n.k&&!$.isArray(n.k)&&(n.k=[n.k]),n.p&&(n.p=n.p*1),$.extend({},s(),n)},t.query=h(),t.$watch("query",t.doSearch,!0),t.querystring=function(){return $.param(t.query,!0)},t.addKeywordsToQuery=function(i){var r,o,u,f,e,c,l,h;for(h=_(i).map(t.keywordToString).partition(function(i){return n.call(t.query.k,i)>=0}).value(),o=h[0],u=h[1],f=0,c=u.length;f<c;f++)r=u[f],t.query.k.push(r);for(e=0,l=o.length;e<l;e++)r=o[e],t.notifications.add("Your query already contains the '"+t.keywordFromString(r).value+"' keyword");if(u.length)return t.query=angular.extend({},s(),{k:t.query.k})},t.removeKeywordFromQuery=function(n){var i;return i=t.keywordToString(n),t.query.k.splice($.inArray(i,t.query.k),1)},t.keywordToString=function(n){var t;return t=n.vocab?n.vocab+"/"+n.value:n.value,t.replace("http://","")},t.keywordFromString=function(n){var t;return n.indexOf("/")===-1?{vocab:"",value:n}:(t=n.lastIndexOf("/"),{vocab:"http://"+n.substring(0,t),value:n.substring(t+1)})},t.openVocabulator=function(){var n;return n=o.open({controller:"VocabulatorController",templateUrl:"views/partials/vocabulator.html?"+(new Date).getTime(),size:"lg",scope:t}),n.result.then(function(n){return t.addKeywordsToQuery(n)})},t.setPage=function(n){if(n>0&&n<=t.maxPages(t.result.total,t.pageSize)+1)return t.query.p=n-1},t.range=function(n,t,i){var u,e,r,f;for(i=i===void 0?1:i,e=[],f=[],u=r=0;i>0?r<=t:r>=t;u=r+=i)f.push(e.push(u));return f},t.maxPages=function(n,t){return Math.ceil(n/t)-1},u.get("../api/collections").success(function(n){return t.collections=_.chunk(n,2)}),u.get("../api/usage").success(function(n){return t.recentModifications=n.recentlyModifiedRecords})})}).call(this);